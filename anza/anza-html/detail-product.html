{% extends 'new_base.html' %}
{% load static %}
{% block title %}
<title>{{ product.name }} - Bizmob</title>
{% endblock %}
{% block meta %}
<meta property="og:title" content="Anza | Detail Product" />
{% endblock %}
{% block script %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
{% endblock %}
{% block link %}
<link rel="stylesheet" href="{% static './new-styles.css' %}" />
<link rel="stylesheet" href="{% static './detail-product.css' %}" />
{% endblock %}
{% block divclass %}container-fluid w-100 m-0 p-0{% endblock %}
{% block content %}
<div class="container-fluid">
  <header class="row p-1 mt-1">
      {% if product_owner == request.user %}
      <div class="col-lg-2"></div>
      <h3 class="text-center my-2 col-lg-8">Business info</h3>
      <div class="col-lg-1 d-flex justify-content-center align-items-center">
          <button type="button" class="btn btn-primary" data-bs-toggle="editModal" data-bs-target="#editProductModal">Edit</button>
      </div>
      <div class="col-lg-1 d-flex justify-content-center align-items-center">
        <button type="button" class="btn btn-danger" data-bs-toggle="deleteModal" data-bs-target="#deleteProductModal">Delete</button>
      </div>
      {% else %}
      <h3 class="text-center my-2 col-12">Business info</h3>
      {% endif %}
  </header>
  <div class="row d-flex justify-content-center mt-1">
      <div class="col-sm-4 text-center">
        {% with product.is_cover_image as cover_image %}
        <img
          alt="image"
          src="{{ cover_image.image.url|default:'https://images.unsplash.com/photo-1605548230624-8d2d0419c517?ixid=M3w5MTMyMXwwfDF8c2VhcmNofDE0fHxjb2tlfGVufDB8fHx8MTcyMDEwNzE5MHww&amp;ixlib=rb-4.0.3&amp;w=200' }}"
          class="detail-product-image"
        />
        {% endwith %}
        <figcaption class="figure-caption">{{ product.name }}</figcaption>
      </div>
      <div class="col-sm-4 d-flex align-items-top justify-content-center">
              <ul class="list-group list-group-flush border-top border-bottom">
                  <li class="list-group-item">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-alphabet m-2" viewBox="0 0 16 16">
                          <path d="M2.204 11.078c.767 0 1.201-.356 1.406-.737h.059V11h1.216V7.519c0-1.314-.947-1.783-2.11-1.783C1.355 5.736.75 6.42.69 7.27h1.216c.064-.323.313-.552.84-.552s.864.249.864.771v.464H2.346C1.145 7.953.5 8.568.5 9.496c0 .977.693 1.582 1.704 1.582m.42-.947c-.44 0-.845-.235-.845-.718 0-.395.269-.684.84-.684h.991v.538c0 .503-.444.864-.986.864m5.593.937c1.216 0 1.948-.869 1.948-2.31v-.702c0-1.44-.727-2.305-1.929-2.305-.742 0-1.328.347-1.499.889h-.063V3.983h-1.29V11h1.27v-.791h.064c.21.532.776.86 1.499.86Zm-.43-1.025c-.66 0-1.113-.518-1.113-1.28V8.12c0-.825.42-1.343 1.098-1.343.684 0 1.075.518 1.075 1.416v.45c0 .888-.386 1.401-1.06 1.401Zm2.834-1.328c0 1.47.87 2.378 2.305 2.378 1.416 0 2.139-.777 2.158-1.763h-1.186c-.06.425-.313.732-.933.732-.66 0-1.05-.512-1.05-1.352v-.625c0-.81.371-1.328 1.045-1.328.635 0 .879.425.918.776h1.187c-.02-.986-.787-1.806-2.14-1.806-1.41 0-2.304.918-2.304 2.338z"/>
                          </svg>
                          Reviews: {{ rev_count }}
                  </li>
                  <li class="list-group-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat-left-quote m-2" viewBox="0 0 16 16">
                      <path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414A2 2 0 0 0 3 11.586l-2 2V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/>
                      <path d="M7.066 4.76A1.665 1.665 0 0 0 4 5.668a1.667 1.667 0 0 0 2.561 1.406c-.131.389-.375.804-.777 1.22a.417.417 0 1 0 .6.58c1.486-1.54 1.293-3.214.682-4.112zm4 0A1.665 1.665 0 0 0 8 5.668a1.667 1.667 0 0 0 2.561 1.406c-.131.389-.375.804-.777 1.22a.417.417 0 1 0 .6.58c1.486-1.54 1.293-3.214.682-4.112z"/>
                    </svg>
                      Rating: {{ product.get_rating }}
                  </li>
                  <li class="list-group-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-calendar-week m-2" viewBox="0 0 16 16">
                      <path d="M11 6.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm-3 0a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm-5 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm3 0a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5z"/>
                      <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5M1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4z"/>
                    </svg>
                      Price: Ksh. {{ product.price}}
                  </li>
              </ul>
      </div>
      <div class="col-sm-4 d-flex align-items-top justify-content-center">
          <ul class="list-group list-group-flush border-top border-bottom">
              <li class="list-group-item">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-calendar-heart m-2" viewBox="0 0 16 16">
                      <path fill-rule="evenodd" d="M4 .5a.5.5 0 0 0-1 0V1H2a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-1V.5a.5.5 0 0 0-1 0V1H4zM1 14V4h14v10a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1m7-6.507c1.664-1.711 5.825 1.283 0 5.132-5.825-3.85-1.664-6.843 0-5.132"/>
                  </svg>
                    Created: {{ product.created_at }}
              </li>
              <li class="list-group-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-calendar-week m-2" viewBox="0 0 16 16">
                  <path d="M11 6.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm-3 0a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm-5 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm3 0a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5z"/>
                  <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5M1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4z"/>
                </svg>
                    By: <a href="/business/{{ product.business.business_id }}">{{ product.business }}</a>
              </li>
              <li class="list-group-item">
                  
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-globe m-2" viewBox="0 0 16 16">
                    <path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m7.5-6.923c-.67.204-1.335.82-1.887 1.855A8 8 0 0 0 5.145 4H7.5zM4.09 4a9.3 9.3 0 0 1 .64-1.539 7 7 0 0 1 .597-.933A7.03 7.03 0 0 0 2.255 4zm-.582 3.5c.03-.877.138-1.718.312-2.5H1.674a7 7 0 0 0-.656 2.5zM4.847 5a12.5 12.5 0 0 0-.338 2.5H7.5V5zM8.5 5v2.5h2.99a12.5 12.5 0 0 0-.337-2.5zM4.51 8.5a12.5 12.5 0 0 0 .337 2.5H7.5V8.5zm3.99 0V11h2.653c.187-.765.306-1.608.338-2.5zM5.145 12q.208.58.468 1.068c.552 1.035 1.218 1.65 1.887 1.855V12zm.182 2.472a7 7 0 0 1-.597-.933A9.3 9.3 0 0 1 4.09 12H2.255a7 7 0 0 0 3.072 2.472M3.82 11a13.7 13.7 0 0 1-.312-2.5h-2.49c.062.89.291 1.733.656 2.5zm6.853 3.472A7 7 0 0 0 13.745 12H11.91a9.3 9.3 0 0 1-.64 1.539 7 7 0 0 1-.597.933M8.5 12v2.923c.67-.204 1.335-.82 1.887-1.855q.26-.487.468-1.068zm3.68-1h2.146c.365-.767.594-1.61.656-2.5h-2.49a13.7 13.7 0 0 1-.312 2.5m2.802-3.5a7 7 0 0 0-.656-2.5H12.18c.174.782.282 1.623.312 2.5zM11.27 2.461c.247.464.462.98.64 1.539h1.835a7 7 0 0 0-3.072-2.472c.218.284.418.598.597.933M10.855 4a8 8 0 0 0-.468-1.068C9.835 1.897 9.17 1.282 8.5 1.077V4z"/>
                    </svg>
                  <a href="{{ product.business.website|default_if_none:'' }}">
                    Creator Website
                  </a>
              </li>
          </ul>
  </div>
  </div>


{% if product_owner == request.user %}
<!-- Edit modal -->
<div id="edit-pd-modal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <form id="update-review-form" action="" method="post">
      {% csrf_token %}
      <!-- Form content here -->
      <div class="banner1-container2">
        <div class="banner1-container3">
          <label for="id_rating" class="banner1-text thq-heading-3">
            <span>Rating</span>
          </label>
          <select
            name="rating"
            id="id_rating"
            class="banner1-input thq-input"
            required
          >
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
          </select>
        </div>
        <div class="banner1-container4">
          <label for="id_review" class="banner1-text thq-heading-3">
            <span>Review Title</span>
          </label>
          <textarea
            name="review"
            id="id_review"
            class="banner1-input thq-input banner1-input1"
          ></textarea>
        </div>
        <div class="banner1-container4">
          <label for="id_review_description" class="banner1-text thq-heading-3">
            <span>Review Description</span>
          </label>
          <textarea
            name="review_description"
            id="id_review_description"
            class="banner1-input thq-input banner1-input1"
          ></textarea>
        </div>
        <input type="hidden" name="review_id" id="id_review_id" value="">
        <input type="hidden" name="product_id" id="id_product_id" value="{{ product.product_id }}">
        <div class="banner1-container5">
          <button
            type="submit"
            class="banner1-action thq-button-filled thq-button-animated"
          >
            <span class="banner1-text1 thq-body-small">
              <span>Submit</span>
            </span>
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
<!-- Delete product modal -->
<div id="delete-pd-modal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <form id="delete-pd-form" action="" method="post">
      {% csrf_token %}
      <p>Are you sure you want to delete this product?</p>
      <div class="banner1-container5" id="confirm-delete-container">
        <button type="submit" class="banner1-action thq-button-filled thq-button-animated">
          <span class="banner1-text1 thq-body-small">
            <span class="delete-bs-btn" id="delete-btn-modal">Delete</span>
          </span>
        </button>
        <button type="button" class="close-modal banner1-action thq-button-filled thq-button-animated" id="exit-pd-modal-button">
          <span class="banner1-text1 thq-body-small">
            <span>Cancel</span>
          </span>
        </button>
      </div>
    </form>
  </div>
</div>
{% endif %}

<header class="row p-1 mt-2" style="border-top: 1px black">
  <h3 class="text-center my-2 col-12">Description</h3>
</header>
<div class="d-flex">
  <div class="col-12">
    <h5 class="text-center align-items-center justify-content-center">
      <span class="text-center align-items-center justify-content-center">
        {{ product.description }}
      </span>
    </h5>
  </div>
</div>

<header class="row p-1 mt-1">
  <h3 class="text-center my-2 col-12">Reviews</h3>
</header>
<div class="w-100">
{% if product_owner != request.user %}
{% if self_review_bool is not True %}
  <form method="post" id="review-form" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="banner1-max-width thq-section-max-width">
      <div class="banner1-container1">
        <h2 class="banner1-title thq-heading-2">
          <span>Leave a Review</span>
        </h2>
        <div class="banner1-container2">
          <div class="banner1-container3">
            <label for="id_rating" class="banner1-text thq-heading-3">
              <span>Rating</span>
            </label>
            <select
              name="rating"
              id="id_rating"
              class="banner1-input thq-input"
              required
            >
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
            </select>
          </div>
          <div class="banner1-container4">
            <label for="id_review" class="banner1-text thq-heading-3">
              <span>Review Title</span>
            </label>
            <textarea
              name="review"
              id="id_review"
              class="banner1-input thq-input banner1-input1"
            ></textarea>
          </div>
          <div class="banner1-container4">
            <label for="id_review_description" class="banner1-text thq-heading-3">
              <span>Review Description</span>
            </label>
            <textarea
              name="review_description"
              id="id_review_description"
              class="banner1-input thq-input banner1-input1"
            ></textarea>
          </div>
          <div class="banner1-container5">
            <button
              type="submit"
              class="banner1-action thq-button-filled thq-button-animated"
            >
              <span class="banner1-text1 thq-body-small">
                <span>Submit</span>
              </span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </form>
  {% else %}
<h5>
  Your review:
</h5>
<p>{{ self_review.review }} | Rated: {{ self_review.rating }}
</p>
<p>
{{ self_review.review_description }}
</p>
<button class="banner1-action thq-button-filled thq-button-animated" id="edit-review-btn">
    <span>Edit Review</span>
</button>
<button class="banner1-action thq-button-outline thq-button-animated" id="delete-review-btn">
    <span id="delete-btn-1">Delete Review</span>
</button>

<div id="reviewModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <form id="update-review-form" action="" method="post">
      {% csrf_token %}
      <!-- Form content here -->
      <div class="banner1-container2">
        <div class="banner1-container3">
          <label for="id_rating" class="banner1-text thq-heading-3">
            <span>Rating</span>
          </label>
          <select
            name="rating"
            id="id_rating"
            class="banner1-input thq-input"
            required
          >
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
          </select>
        </div>
        <div class="banner1-container4">
          <label for="id_review" class="banner1-text thq-heading-3">
            <span>Review Title</span>
          </label>
          <textarea
            name="review"
            id="id_review"
            class="banner1-input thq-input banner1-input1"
          ></textarea>
        </div>
        <div class="banner1-container4">
          <label for="id_review_description" class="banner1-text thq-heading-3">
            <span>Review Description</span>
          </label>
          <textarea
            name="review_description"
            id="id_review_description"
            class="banner1-input thq-input banner1-input1"
          ></textarea>
        </div>
        <input type="hidden" name="review_id" id="id_review_id" value="">
        <input type="hidden" name="product_id" id="id_product_id" value="{{ product.product_id }}">
        <div class="banner1-container5">
          <button
            type="submit"
            class="banner1-action thq-button-filled thq-button-animated"
          >
            <span class="banner1-text1 thq-body-small">
              <span>Submit</span>
            </span>
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
<!-- Delete Review Modal -->
<div id="deleteReviewModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <form id="delete-review-form" action="" method="post">
      {% csrf_token %}
      <p>Are you sure you want to delete this review?</p>
      <div class="banner1-container5" id="confirm-delete-container">
        <button type="submit" class="banner1-action thq-button-filled thq-button-animated">
          <span class="banner1-text1 thq-body-small">
            <span id="delete-btn-2">Delete</span>
          </span>
        </button>
        <button type="button" class="close-modal banner1-action thq-button-filled thq-button-animated" id="exit-modal-button">
          <span class="banner1-text1 thq-body-small">
            <span>Cancel</span>
          </span>
        </button>
      </div>
    </form>
  </div>
</div>

{% endif %}
{% endif %}
</div>
{% for review in reviews %}
<h4>{{ review.review }} | Rated: {{ review.rating }}</h4>
<span>{{ review.review_description }}</span>
{% endfor %}
{% endblock %}
{% block scripts_end %}
<script
  defer=""
  src="https://unpkg.com/@teleporthq/teleport-custom-scripts"
></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    var form = document.getElementById("review-form");
    if (form) {
      form.action = window.location.pathname + "review/create/";
    }
  });
</script>
<script>
  $(document).ready(function() {
    $("#review-form").submit(function(e) {
      e.preventDefault();
      e.stopPropagation();
      const formData = new FormData(this)
      $.ajax({
        type: "POST",
        url: $(this).attr("action"),
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
          console.log(response);
          var currentUrl = window.location.pathname;
          window.location = currentUrl;
        },
        error: function(error) {
          console.log(error);
        }
      });
    });
  })
</script>
<script>
  // Get the modal
  var editModal = document.getElementById("reviewModal");

  // Get the button that opens the modal
  var editBtn = document.getElementById("edit-review-btn");

  // Get the <span> element that closes the modal
  var span = document.getElementsByClassName("close")[0];

  // When the user clicks the button, open the modal & update text fields
  editBtn.onclick = function() {
    editModal.style.display = "block";
    const id_rating = document.getElementById("id_rating");
    id_rating.value = "{{ self_review.rating }}";
    const id_review = document.getElementById("id_review");
    id_review.value = "{{ self_review.review }}";
    const id_review_description = document.getElementById("id_review_description");
    id_review_description.value = "{{ self_review.review_description }}";
    const review_id = document.getElementById("id_review_id");
    review_id.value = "{{ self_review.id }}";
    document.getElementById("update-review-form").action = "/products/review/{{ self_review.id }}/update/";
  }

  // When the user clicks on <span> (x) close the modal
  span.onclick = function() {
    editModal.style.display = "none";
  }

  // When the user clicks anywhere outside of the modal, close it
  window.onclick = function(event) {
    if (event.target == editModal) {
      editModal.style.display = "none";
    }
  }
</script>
<script>
  // Get the modal
  var delModal = document.getElementById("deleteReviewModal");

  // Get the button that opens the modal
  var delBtn = document.getElementById("delete-review-btn");

  // Get the <span> element that closes the modal
  var span = document.getElementsByClassName("close")[1];
  const closeBtn = document.getElementById("exit-modal-button");

  delBtn.onclick = function() {
    delModal.style.display = "block";
    document.getElementById("delete-review-form").action = "/products/review/{{ self_review.id }}/delete/";
  }
  span.onclick = function() {
    delModal.style.display = "none";
  }
  closeBtn.onclick = function() {
    delModal.style.display = "none";
  }
  window.onclick = function(event) {
    if (event.target == delModal) {
      delModal.style.display = "none";
    }
  }
</script>
<script>
  // Get the modal
  var deletePDmodal = document.getElementById("delete-pd-modal");

  // Get the button that opens the modal
  var deletePDbtn = document.getElementById("delete-pd-btn");

  // Get the <span> element that closes the modal
  var closeSpan = document.getElementsByClassName("close")[0];
  const closeModalBtn = document.getElementById("exit-pd-modal-button");

  deletePDbtn.onclick = function() {
    deletePDmodal.style.display = "block";
    document.getElementById("delete-pd-form").action = "/products/{{ product.id }}/delete/";
  }
  closeSpan.onclick = function() {
    deletePDmodal.style.display = "none";
  }
  closeModalBtn.onclick = function() {
    deletePDmodal.style.display = "none";
  }
  window.onclick = function(event) {
    if (event.target == deletePDmodal) {
      deletePDmodal.style.display = "none";
    }
  }
</script>
<script>
  $(document).ready(function() {
    $("#update-review-form").submit(function(e) {
      e.preventDefault();
      e.stopPropagation();
      const formData = new FormData(this)
      $.ajax({
        type: "POST",
        url: $(this).attr("action"),
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
          console.log(response);
          var currentUrl = window.location.pathname;
          window.location = currentUrl;
        },
        error: function(error) {
          console.log(error);
        }
      });
    });
  })
</script>
{% endblock %}